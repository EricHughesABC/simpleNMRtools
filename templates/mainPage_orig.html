<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    .tooltip {
        position: absolute;
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 8px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        pointer-events: none;
        display: inline-block;
        max-width: 480px; /* Set max-width for the tooltip */
    }

    /* Style for the SVG border */
    svg {
        position: relative; /* Set position relative to make it a positioning context */
        border: 1px solid black; /* 1px solid black border */
        border-radius: 50px; /* Adjust the value to change the roundness of the corners */
    }

    .center {
        display: block;
        margin-left: auto;
        margin-right: auto;
    }
 
    .container {
        display: flex; /* Use flexbox */
        justify-content: center; /* Center the content horizontally */
        margin: 0 auto; /* Set the left and right margins to auto to center the container */
    }

    .group {
        border: 1px solid black;
        border-radius: 10px; /* Adjust the value to change the roundness of the corners */
        display: block;
        margin-right: 10px; /* Add some space between the groups */
        padding: 10px; /* Add padding inside the border *
        padding: 10px; /* Add padding inside the border */
    }

    .group:last-child {
        margin-right: 0; /* Remove margin from the last group */
    }

    .color-container {
        position: relative;
        display: inline-block;
        
    }

    .color-box {
        width: 100px;
        height: 50px;
        border-radius: 7px;
    }

    .striped-rectangle {
        width: 100px;
        height: 50px;
        background: repeating-linear-gradient(90deg, #ccc, #ccc 10px, #fff 10px, #fff 20px);
    }

    .color-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: black; /* Adjust text color as needed */
    }

    .orange { background-color: #FFA500; }
    .green { background-color: #98FB98; }
    .yellow { background-color: yellow; }
    .cyan { background-color: #00FFFF; }
    .grey { background-color: #808080; }
    .blue { background-color: #ADD8E6; }
</style>


  <title>simpleNMR</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>

     <!-- SVG container with background molecule image -->
    <br>

    <?xml version="1.0" encoding="iso-8859-1"?>
<svg class="center" version="1.1" baseProfile="full"
              xmlns="http://www.w3.org/2000/svg"
                      xmlns:rdkit="http://www.rdkit.org/xml"
                      xmlns:xlink="http://www.w3.org/1999/xlink"
                  xml:space="preserve"
width=1200 height=700 viewBox="0 0 1200 700">
<!-- END OF HEADER -->
<g transform="translate(100, 50)">
<rect style="opacity:1.0;fill:none;stroke:none" width="1000" height="600" x="0" y="0"> </rect>
<path class="bond-0" d="M 45.4545,301.511 L 165.264,441.146" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-1" d="M 165.264,441.146 L 346.095,407.205" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-2" d="M 346.095,407.205 L 479.844,533.551" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-11" d="M 346.095,407.205 L 424.927,240.96" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-3" d="M 479.844,533.551 L 641.336,445.392" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-4" d="M 641.336,445.392 L 814.911,506.414" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-4" d="M 679.577,419.83 L 801.079,462.546" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-9" d="M 641.336,445.392 L 607.396,264.56" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-5" d="M 814.911,506.414 L 954.545,386.605" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-6" d="M 954.545,386.605 L 920.605,205.774" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-6" d="M 913.288,366.268 L 889.53,239.686" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-7" d="M 920.605,205.774 L 747.03,144.751" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-8" d="M 747.03,144.751 L 607.396,264.56" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-8" d="M 750.047,190.649 L 652.303,274.516" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-10" d="M 607.396,264.56 L 424.927,240.96" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-12" d="M 441.076,232.144 L 402.28,161.077" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-12" d="M 402.28,161.077 L 363.485,90.0109" style="fill:none;fill-rule:evenodd;stroke:#FF0000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-12" d="M 408.777,249.776 L 369.982,178.709" style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path class="bond-12" d="M 369.982,178.709 L 331.186,107.643" style="fill:none;fill-rule:evenodd;stroke:#FF0000;stroke-width:2.0px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
<path  class="atom-11" d="M 323.767 79.5471
Q 323.767 72.7471, 327.127 68.9471
Q 330.487 65.1471, 336.767 65.1471
Q 343.047 65.1471, 346.407 68.9471
Q 349.767 72.7471, 349.767 79.5471
Q 349.767 86.4271, 346.367 90.3471
Q 342.967 94.2271, 336.767 94.2271
Q 330.527 94.2271, 327.127 90.3471
Q 323.767 86.4671, 323.767 79.5471
M 336.767 91.0271
Q 341.087 91.0271, 343.407 88.1471
Q 345.767 85.2271, 345.767 79.5471
Q 345.767 73.9871, 343.407 71.1871
Q 341.087 68.3471, 336.767 68.3471
Q 332.447 68.3471, 330.087 71.1471
Q 327.767 73.9471, 327.767 79.5471
Q 327.767 85.2671, 330.087 88.1471
Q 332.447 91.0271, 336.767 91.0271
" fill="#FF0000"/>
<path  d="M 45.4545,301.511 L 165.264,441.146" class="bond-selector bond-0" style="fill:#fff;stroke:#fff;stroke-width:4px;fill-opacity:0;stroke-opacity:0" />
<path  d="M 165.264,441.146 L 346.095,407.205" class="bond-selector bond-1" style="fill:#fff;stroke:#fff;stroke-width:4px;fill-opacity:0;stroke-opacity:0" />
<path  d="M 346.095,407.205 L 479.844,533.551" class="bond-selector bond-2" style="fill:#fff;stroke:#fff;stroke-width:4px;fill-opacity:0;stroke-opacity:0" />
<path  d="M 479.844,533.551 L 641.336,445.392" class="bond-selector bond-3" style="fill:#fff;stroke:#fff;stroke-width:4px;fill-opacity:0;stroke-opacity:0" />
<path  d="M 641.336,445.392 L 814.911,506.414" class="bond-selector bond-4" style="fill:#fff;stroke:#fff;stroke-width:4px;fill-opacity:0;stroke-opacity:0" />
<path  d="M 814.911,506.414 L 954.545,386.605" class="bond-selector bond-5" style="fill:#fff;stroke:#fff;stroke-width:4px;fill-opacity:0;stroke-opacity:0" />
<path  d="M 954.545,386.605 L 920.605,205.774" class="bond-selector bond-6" style="fill:#fff;stroke:#fff;stroke-width:4px;fill-opacity:0;stroke-opacity:0" />
<path  d="M 920.605,205.774 L 747.03,144.751" class="bond-selector bond-7" style="fill:#fff;stroke:#fff;stroke-width:4px;fill-opacity:0;stroke-opacity:0" />
<path  d="M 747.03,144.751 L 607.396,264.56" class="bond-selector bond-8" style="fill:#fff;stroke:#fff;stroke-width:4px;fill-opacity:0;stroke-opacity:0" />
<path  d="M 607.396,264.56 L 641.336,445.392" class="bond-selector bond-9" style="fill:#fff;stroke:#fff;stroke-width:4px;fill-opacity:0;stroke-opacity:0" />
<path  d="M 607.396,264.56 L 424.927,240.96" class="bond-selector bond-10" style="fill:#fff;stroke:#fff;stroke-width:4px;fill-opacity:0;stroke-opacity:0" />
<path  d="M 424.927,240.96 L 346.095,407.205" class="bond-selector bond-11" style="fill:#fff;stroke:#fff;stroke-width:4px;fill-opacity:0;stroke-opacity:0" />
<path  d="M 424.927,240.96 L 336.767,79.4671" class="bond-selector bond-12" style="fill:#fff;stroke:#fff;stroke-width:4px;fill-opacity:0;stroke-opacity:0" />
<circle  cx="45.4545" cy="301.511" r="24.5319" class="atom-selector atom-0" style="fill:#fff;stroke:#fff;stroke-width:1px;fill-opacity:0;stroke-opacity:0" />
<circle  cx="165.264" cy="441.146" r="24.5319" class="atom-selector atom-1" style="fill:#fff;stroke:#fff;stroke-width:1px;fill-opacity:0;stroke-opacity:0" />
<circle  cx="346.095" cy="407.205" r="24.5319" class="atom-selector atom-2" style="fill:#fff;stroke:#fff;stroke-width:1px;fill-opacity:0;stroke-opacity:0" />
<circle  cx="479.844" cy="533.551" r="24.5319" class="atom-selector atom-3" style="fill:#fff;stroke:#fff;stroke-width:1px;fill-opacity:0;stroke-opacity:0" />
<circle  cx="641.336" cy="445.392" r="24.5319" class="atom-selector atom-4" style="fill:#fff;stroke:#fff;stroke-width:1px;fill-opacity:0;stroke-opacity:0" />
<circle  cx="814.911" cy="506.414" r="24.5319" class="atom-selector atom-5" style="fill:#fff;stroke:#fff;stroke-width:1px;fill-opacity:0;stroke-opacity:0" />
<circle  cx="954.545" cy="386.605" r="24.5319" class="atom-selector atom-6" style="fill:#fff;stroke:#fff;stroke-width:1px;fill-opacity:0;stroke-opacity:0" />
<circle  cx="920.605" cy="205.774" r="24.5319" class="atom-selector atom-7" style="fill:#fff;stroke:#fff;stroke-width:1px;fill-opacity:0;stroke-opacity:0" />
<circle  cx="747.03" cy="144.751" r="24.5319" class="atom-selector atom-8" style="fill:#fff;stroke:#fff;stroke-width:1px;fill-opacity:0;stroke-opacity:0" />
<circle  cx="607.396" cy="264.56" r="24.5319" class="atom-selector atom-9" style="fill:#fff;stroke:#fff;stroke-width:1px;fill-opacity:0;stroke-opacity:0" />
<circle  cx="424.927" cy="240.96" r="24.5319" class="atom-selector atom-10" style="fill:#fff;stroke:#fff;stroke-width:1px;fill-opacity:0;stroke-opacity:0" />
<circle  cx="336.767" cy="79.4671" r="24.5319" class="atom-selector atom-11" style="fill:#fff;stroke:#fff;stroke-width:1px;fill-opacity:0;stroke-opacity:0" />
</g>
</svg>
 

    <!-- Tooltip for displaying node information -->
    <div id="tooltip" class="tooltip">Tooltip content</div>
    <br>
   
    <div class="container">
        <!-- First four boxes -->
        <div class="group">
            <div class="color-container">
                <div class="color-box orange"></div>
                <div class="color-text">-C-</div>
            </div>
            <div class="color-container">
                <div class="color-box green"></div>
                <div class="color-text">-CH</div>
            </div>
            <div class="color-container">
                <div class="color-box yellow"></div>
                <div class="color-text">-CH<sub>2</sub></div>
            </div>
            <div class="color-container">
                <div class="color-box cyan"></div>
                <div class="color-text">-CH<sub>3</sub></div>
            </div>
        </div>
        <!-- Last two boxes -->
        <div class="group">
            <div class="color-container">
                <div class="color-box grey"></div>
                <div class="color-text">HMBC</div>
            </div>
            <div class="color-container">
                <div class="color-box blue"></div>
                <div class="color-text">COSY</div>
            </div>
        </div>
    </div>
        
  <script>
    // Create the SVG container
    const svg = d3.select("svg");
    const width = +svg.attr("width");
    const height = +svg.attr("height");

    // Get the corresponding DOM element
    var svgNode = svg.node();
    // Get the dimensions of the SVG element
    var svgWidth = svgNode.clientWidth;
    var svgHeight = svgNode.clientHeight;

    // Define scale functions for x and y coordinates
    const xScale = d3.scaleLinear().domain([0, 1]).range([0, width-100*2]);
    const yScale = d3.scaleLinear().domain([0, 1]).range([0, height-50*2]);

    // define colour blind friendly colours with 50% transparency
    const orange = 'rgba(255, 165, 0, 1)';
    const blue = 'rgba(173, 216, 230, 1)';
    const green = 'rgba(152, 251, 152, 1)';
    const yellow = 'rgba(255, 255, 0, 1)';
    const purple = 'rgba(128, 0, 128, 1)';
    const cyan = 'rgba(0, 255, 255, 1)';
    const grey = 'rgba(128, 128, 128, 1)';

    const black = 'rgba(0, 0, 0, 1)';
    const white = 'rgba(255, 255, 255, 1)';

    // assign colours to parts of the molecule
    const CH3 = cyan;
    const CH2 = yellow;
    const CH = green;
    const C = orange;

    const cosyEdgeColor = blue;
    const cosyEdgeHoverOpacity = 0.0;
    const hmbcEdgeColor = grey;

    const nodeHoverColor = "lightgrey";
    const nodeHoverOpacity = 0.4;
    const textHoverOpacity = 0;

    // define node dimensions
    const nodeRadius = 22;
    const nodeRadiusSmall = 15;
    const nodeRadiusLarge = 26;

    // define edge widths
    const cosyEdgeWidth = 8;
    const hmbcEdgeWidth = 8;
    const noesyEdgeWidth = 8;

    // Define color scale for nodes based on numProtons
    const colorScale = d3.scaleOrdinal()
      .domain([0, 1, 2, 3])
      .range([C, CH, CH2, CH3]); // Blue, Orange, Green, Red

    // Define the graph data
    const nodes = [	{symbol: C, atomNumber: 12, ppm: 11.590135716281154, numProtons: 3, jCouplingVals: [], jCouplingClass: [], H1_ppm: [1.001844729650673], x: 0.045454545454545435, y: 0.5025191050496386, id: 1},
	{symbol: C, atomNumber: 11, ppm: 24.426215530299356, numProtons: 2, jCouplingVals: [], jCouplingClass: [], H1_ppm: [1.9645176822939707, 1.537918883365027], x: 0.1652636481669736, y: 0.7352429500169125, id: 2},
	{symbol: C, atomNumber: 4, ppm: 48.752603844474116, numProtons: 1, jCouplingVals: [], jCouplingClass: [], H1_ppm: [2.6068485122731215], x: 0.346095056608018, y: 0.6786753282445797, id: 3},
	{symbol: C, atomNumber: 3, ppm: 32.38360528872918, numProtons: 2, jCouplingVals: [], jCouplingClass: [], H1_ppm: [3.30748707389514, 2.8071593948899505], x: 0.4798435920480554, y: 0.8892518519854807, id: 4},
	{symbol: C, atomNumber: 2, ppm: 153.8100526069828, numProtons: 0, jCouplingVals: [], jCouplingClass: [], x: 0.641336267521326, y: 0.7423195494791842, id: 5},
	{symbol: C, atomNumber: 10, ppm: 126.53074852776346, numProtons: 1, jCouplingVals: [], jCouplingClass: [], H1_ppm: [7.449431296543523], x: 0.8149111475650901, y: 0.8440233923602113, id: 6},
	{symbol: C, atomNumber: 9, ppm: 134.39440779544722, numProtons: 1, jCouplingVals: [], jCouplingClass: [], H1_ppm: [7.569569954859166], x: 0.9545454545454544, y: 0.6443415545061644, id: 7},
	{symbol: C, atomNumber: 8, ppm: 127.26955890842112, numProtons: 1, jCouplingVals: [], jCouplingClass: [], H1_ppm: [7.352275399932183], x: 0.9206048814820548, y: 0.3429558737710905, id: 8},
	{symbol: C, atomNumber: 7, ppm: 123.83373239562019, numProtons: 1, jCouplingVals: [], jCouplingClass: [], H1_ppm: [7.737564351158939], x: 0.7470300014382907, y: 0.24125203089006345, id: 9},
	{symbol: C, atomNumber: 1, ppm: 136.95499691771573, numProtons: 0, jCouplingVals: [], jCouplingClass: [], x: 0.6073956944579263, y: 0.4409338687441103, id: 10},
	{symbol: C, atomNumber: 5, ppm: 208.9336188069547, numProtons: 0, jCouplingVals: [], jCouplingClass: [], x: 0.4249265912338256, y: 0.40159957683360675, id: 11},
];
    const links = [	{cosy: true, hmbc: true, source: 1, target: 2.0},
	{hmbc: true, source: 1, target: 3.0},
	{cosy: true, hmbc: true, source: 2, target: 3.0},
	{hmbc: true, source: 2, target: 4.0},
	{hmbc: true, source: 2, target: 11.0},
	{cosy: true, hmbc: true, source: 3, target: 4.0},
	{hmbc: true, source: 3, target: 5.0},
	{hmbc: true, source: 3, target: 11.0},
	{hmbc: true, source: 4, target: 5.0},
	{hmbc: true, source: 4, target: 7.0},
	{hmbc: true, source: 4, target: 11.0},
	{hmbc: true, source: 4, target: 10.0},
	{hmbc: true, source: 4, target: 6.0},
	{hmbc: true, source: 5, target: 9.0},
	{hmbc: true, source: 5, target: 7.0},
	{cosy: true, hmbc: true, source: 6, target: 7.0},
	{hmbc: true, source: 6, target: 10.0},
	{hmbc: true, source: 6, target: 8.0},
	{cosy: true, source: 7, target: 8.0},
	{hmbc: true, source: 7, target: 9.0},
	{cosy: true, source: 8, target: 9.0},
	{hmbc: true, source: 8, target: 10.0},
	{hmbc: true, source: 9, target: 11.0},
];

    // Set initial positions of nodes and links
    nodes.forEach(node => {
        node.x = xScale(node.x)+100;
        node.y = yScale(node.y)+50;
    });

    // Filter links that have the attribute cosy as true
    // const cosyLinks = links.filter(link => link.cosy);
    const cosyLinks = links.filter(eachLink => eachLink.cosy);

    // Create the COSY links to start
    const link = svg.selectAll(".link")
      .data(cosyLinks)
      .enter().append("line")
      .attr("class", "link")
      .attr("stroke", cosyEdgeColor)
      .attr("x1", d => nodes.find(node => node.id === d.source).x)
      .attr("y1", d => nodes.find(node => node.id === d.source).y)
      .attr("x2", d => nodes.find(node => node.id === d.target).x)
      .attr("y2", d => nodes.find(node => node.id === d.target).y)
      .attr("stroke", blue) // Set the stroke color for links to blue
      .attr("stroke-width", cosyEdgeWidth); // Set the stroke width to 8 pixels

    // Create the nodes
    const node = svg.selectAll(".node")
      .data(nodes)
      .enter().append("g")
      .attr("class", "node")
      .attr("transform", d => `translate(${d.x},${d.y})`)
      .on("mouseover", (event, d) => handleMouseOver(event, d)) // Call function when mouseover
      .on("mouseout", (event, d) => handleMouseOut(event, d))  // Call function when mouseout
      .call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended));

    // Add circles to represent nodes
    node.append("circle")
      .attr("r", nodeRadius)
      .attr("fill", d => colorScale(d.numProtons)) // Set fill color based on numProtons

    // Append text
    node.append("text")
        .attr("class", "node-text")
        .text(d => d.atomNumber) // Display the id
        .attr("dy", -8) // Center the text vertically
        .attr("font-size", "12px") // Set font size to 16 pixels
        .attr("text-anchor", "middle"); // Center the text horizontally

    // // Append ppm text
    node.append("text")
        .attr("class", "node-text")
        .text(d => d.ppm.toFixed(2)) // Display the id
        .attr("dy", +8) // Center the text vertically
        .attr("font-size", "12px") // Set font size to 16 pixels
        .attr("text-anchor", "middle"); // Center the text horizontally

    // Tooltip for node hover
    const tooltip = d3.select("#tooltip");

    tooltip.style("opacity", 0);

    let hmbcLinks = []; // Track hmbc links separately
    var circlenodes = document.querySelectorAll('.node circle');
    var textnodes = document.querySelectorAll('.node text');

    var dragstartedFlag = false;

    // Drag handlers
    function dragstarted(event, d) {
        // change the opacity of the cosy links to 0
        link.style("opacity", 0);
        // Remove hmbc links
        hmbcLinks.forEach(eachHMBClink => eachHMBClink.remove());
        hmbcLinks = []; // Clear the hmbc links array
        d3.select(this).raise().classed("active", true);
        dragstartedFlag = true;
    }

    function dragged(event, d) {
        d.x = event.x;
        d.y = event.y;
        link.filter(l => l.source === d.id).attr("x1", d.x).attr("y1", d.y);
        link.filter(l => l.target === d.id).attr("x2", d.x).attr("y2", d.y);
        d3.select(this).attr("transform", `translate(${d.x},${d.y})`);
    }

    function dragended(event, d) {
      d3.select(this).classed("active", false);
      dragstartedFlag = false;
      handleMouseOver(event, d); // Call handleMouseOut function to reset the view
    }

    // Function to find nearest neighbors and non-nearest neighbours of a node with a specific attribute
    function findNearestNeighbors(nodeId, attribute) {
        const neighbors = [];
        const nonNeighbors = [];

        // Iterate through the links
        links.forEach(link => {
            if (link[attribute] && (link.source === nodeId || link.target === nodeId)) {
                neighbors.push(link.source === nodeId ? link.target : link.source);
            }
        });

        // Iterate through all nodes to find non-neighbors
        nodes.forEach(node => {
            if (node.id !== nodeId && !neighbors.includes(node.id)) {
                nonNeighbors.push(node.id);
            }
        });

        return { neighbors, nonNeighbors };
    }

    // Function to display tooltip
    function displayTooltip(event, d){
        // generate the html sub string for d.H1 ppm which is an array

        // When numProtons is 0
        if (d.numProtons == 0) {
            var htmlstr =  `C${d.atomNumber} <b>${generateHTMLnumProtonsString(d.numProtons)}</b>: <sup>13</sup>C = ${d.ppm.toFixed(2)} ppm`;
        } else if (d.H1_ppm.length == 1) {
            // Expect d.H1 to be an array of length 1
            var htmlstr =  `C${d.atomNumber} <b>${generateHTMLnumProtonsString(d.numProtons)}</b>: <sup>13</sup>C = ${d.ppm.toFixed(2)} ppm, <sup>1</sup>H = ${d.H1_ppm[0].toFixed(2)} ppm`;
            
            // if jCouplingVals is not empty, add the J coupling values
            if (d.jCouplingClass.length > 0) {
                htmlstr = htmlstr + `<br>J's : ${d.jCouplingClass[0]} : ${d.jCouplingVals[0]} Hz`;
            }
        } else {
            // Expect d.H1 to be an array of length 2
            var htmlstr =  `C${d.atomNumber} <b>${generateHTMLnumProtonsString(d.numProtons)}</b>: <sup>13</sup>C = ${d.ppm.toFixed(2)} ppm, <sup>1</sup>H = ${d.H1_ppm[0].toFixed(2)} & ${d.H1_ppm[1].toFixed(2)} ppm`;
            // add the J coupling values if not empty
            if(d.jCouplingClass.length > 0) {

                htmlstr = htmlstr + `<br>J's : ${d.jCouplingClass[0]} : ${d.jCouplingVals[0]} Hz, ${d.jCouplingClass[1]} : ${d.jCouplingVals[1]} Hz`;
            }
        }

        tooltip.transition()
            .duration(200)
            .style("opacity", 9.75);
        tooltip.html(htmlstr)    
            .style("left", (-99999) + "px")
            .style("top", (-99999) + "px")
            .style("display", "inline-block");

        var tooltipDiv = d3.select('#tooltip');

        // Get the corresponding DOM element
        var tooltipNode = tooltipDiv.node();

        var pageWidth = document.documentElement.clientWidth;

        // Get the dimensions of the div element
        var tooltipWidth = tooltipNode.clientWidth;
        var tooltipHeight = tooltipNode.clientHeight;
        var tooltipX = (pageWidth - tooltipWidth) / 2;

        tooltip.html(htmlstr) 
            .style("left", (tooltipX) + "px")
            .style("top", (30) + "px")
            .style("display", "inline-block");

        // Increase the radius of the hovered over node using d.id
        circlenodes.forEach(function(circleNode) {
            if (circleNode.__data__.id == d.id) {
                console.log("circleNode", circleNode.__data__.id);
                circleNode.setAttribute("r", nodeRadiusLarge);
            }
        });
    }

    // Function to highlight HMBC neighbors
    function highlightHMBCneighbors(event, d) {
        // select all the nodes circles
        // var circlenodes = document.querySelectorAll('.node circle');

        // Define the attribute to find nearest neighbors
        const attribute = "hmbc";
        const attribute2 = "noesy";
        
        // Call the function to find nearest neighbors
        const hmbcNearestNodes = findNearestNeighbors(d.id, attribute);
        const noesyNearestNodes = findNearestNeighbors(d.id, attribute2);

        const nearestNeighborIDs = hmbcNearestNodes.neighbors;
        const nearestNeighborIDs2 = noesyNearestNodes.neighbors;
    
        // change the opacity of the nodes to 0.5
        hmbcNearestNodes.nonNeighbors.forEach(nonNeighborId => {
            circlenodes.forEach(function(circleNode) {
                if (circleNode.__data__.id == nonNeighborId) {
                    circleNode.style.opacity = nodeHoverOpacity;
                    circleNode.setAttribute("r", nodeRadiusSmall);
                }
            });
        });
        // set the font colour to grey for all the text nodes
        hmbcNearestNodes.nonNeighbors.forEach(i => {
            textnodes.forEach(function(textNode) {
                if (textNode.__data__.id == i) {
                    textNode.style.fill = nodeHoverColor;
                    textNode.style.opacity = textHoverOpacity;
                }
            });
        });



        // increase the size of the circles for the nearest neighbors
        nearestNeighborIDs.forEach(i => {
            circlenodes.forEach(function(circleNode) {
                if (circleNode.__data__.id == i) {
                    circleNode.setAttribute("r",  nodeRadiusLarge);
                }
            });
        });

        // change the opacity of the cosy links to 0
        link.style("opacity", 0);

        // Add hmbc links to nearest neighbors
        nearestNeighborIDs.forEach(neighborID => {
            const neighborNode = nodes.find(node => node.id === neighborID);
            if (neighborNode) {
                const hmbclink = svg.insert("line", ".node")
                    .attr("class", "hmbclink")
                    .attr("x1", d.x)
                    .attr("y1", d.y)
                    .attr("x2", neighborNode.x)
                    .attr("y2", neighborNode.y)
                    .attr("stroke", grey)
                    .attr("stroke-width", hmbcEdgeWidth); // Set the stroke width to 2 pixels
                hmbcLinks.push(hmbclink); // Track the hmbc links
            }
        });
    }

    // Function to handle mouseover event
    function handleMouseOver(event, d) {

        // console.log("handleMouseOver :: dragstartedFlag", dragstartedFlag);
        if (dragstartedFlag) {
            return;
        }   
        // Display tooltip
        if (event) {
            displayTooltip(event, d);
            console.log("displayTooltip ended")
            highlightHMBCneighbors(event,d);
        }
    }

    // Function to handle mouseout event
    function handleMouseOut(event, d) {
        if (dragstartedFlag) {
            return;
        }   
        // change the opacity of the text nodes to 1
        // reset the font colour of the text in the nodes to black
        textnodes.forEach( t => {
            t.style.opacity = 1;
            t.style.fill = 'black';
        });

        // set the opacity of all the nodes to 1
        circlenodes.forEach( c => {
            c.style.opacity = 1;
        });

        // reset the fill color of all the circles to their original color
        // loop through the nodes to get the id and numProtons
        nodes.forEach(d => {
            circlenodes.forEach( function(circleNode) {
                if (circleNode.__data__.id == d.id) {
                    circleNode.style.fill = colorScale(d.numProtons);
                    circleNode.setAttribute("r", nodeRadius);
                }
            });
        });

        // Hide the tooltip
        tooltip.transition()
                .duration(100)
                .style("opacity", 0);
        // Revert the radius
        d3.select(event.target)
            .transition()
            .duration(100)
            .attr("r", nodeRadius);

        // Remove hmbc links
        hmbcLinks.forEach(link => link.remove());
        hmbcLinks = []; // Clear the hmbc links array

        // change the opacity of the cosy links to 1
        link.style("opacity", 1);
    }

    function generateHTMLnumProtonsString(index) {
        switch (index) {
            case 0:
            return "-C-";
            case 1:
            return "-CH";
            case 2:
            return "-CH<sub>2</sub>";
            case 3:
            return "-CH<sub>3</sub>";
            default:
            return "<p>Invalid index</p>";
        }
    }
  </script>
</body>
</html>
